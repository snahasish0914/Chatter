<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatter — Realtime Firebase Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #6b7280;
      --text: #e5e7eb;
      --brand: #22c55e;
      --border: #1f2937;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(120deg, #0b1224 0%, #0f172a 100%); color: var(--text); }
    .auth-shell, .home-shell { display: grid; place-items: center; height: 100vh; padding: 24px; }
    .card { width: 100%; max-width: 420px; background: rgba(17, 24, 39, .75); border: 1px solid var(--border); border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .card h1 { margin: 0 0 8px; font-size: 24px; }
    .card p { margin: 0 0 18px; color: var(--muted); font-size: 14px; }
    .field { display: grid; gap: 8px; margin-bottom: 14px; }
    .field label { font-size: 12px; color: var(--muted); }
    .input { width: 100%; background: #0b1020; color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px; outline: none; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: 0; cursor: pointer; border-radius: 12px; padding: 12px 14px; font-weight: 600; }
    .btn-primary { background: var(--brand); color: #00130a; }
    .error { color: var(--danger); font-size: 13px; margin-top: 8px; }
    .popup { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--brand); color: #00130a; padding: 12px 20px; border-radius: 8px; display: none; font-weight: 600; z-index: 1000; }
    .home-container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .friends-list { width: 100%; max-width: 420px; background: var(--panel); border-radius: 12px; padding: 16px; max-height: 400px; overflow-y: auto; }
    .friend-item { padding: 8px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .chat-box { width: 100%; max-width: 420px; height: 300px; background: var(--panel); border-radius: 12px; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
    .message { padding: 6px 10px; border-radius: 12px; background: var(--accent); max-width: 80%; word-wrap: break-word; }
    .message.self { align-self: flex-end; background: var(--brand); color: #00130a; }
  </style>
</head>
<body>
  <div class="popup" id="popup"></div>

  <section id="auth" class="auth-shell">
    <div class="card" id="auth-card">
      <h1 id="auth-title">Welcome</h1>
      <p id="auth-sub">Choose sign up or log in to continue.</p>
      <div id="signupForm" hidden>
        <div class="field"><label for="name">Name</label><input id="name" class="input" placeholder="Ada Lovelace" autocomplete="name" /></div>
        <div class="field"><label for="email">Email</label><input id="email" class="input" type="email" placeholder="you@example.com" autocomplete="email" /></div>
        <div class="field"><label for="password">Password</label><input id="password" class="input" type="password" placeholder="••••••••" autocomplete="new-password" /></div>
        <button id="signupBtn" class="btn btn-primary" style="width:100%">Sign up</button>
        <p style="margin-top:10px;text-align:center">Already have an account? <a href="#" id="gotoLogin">Log in</a></p>
      </div>
      <div id="loginForm">
        <div class="field"><label for="loginEmail">Email</label><input id="loginEmail" class="input" type="email" placeholder="you@example.com" autocomplete="email" /></div>
        <div class="field"><label for="loginPassword">Password</label><input id="loginPassword" class="input" type="password" placeholder="••••••••" autocomplete="current-password" /></div>
        <div class="field" style="display:flex;align-items:center;justify-content:space-between;"><div style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="rememberMe" /><label for="rememberMe">Remember me</label></div><a href="#" id="forgotPassword" style="font-size:12px;color:var(--brand);">Forgot password?</a></div>
        <button id="loginBtn" class="btn btn-primary" style="width:100%">Log in</button>
        <p style="margin-top:10px;text-align:center">No account? <a href="#" id="gotoSignup">Sign up</a></p>
      </div>
      <div id="auth-error" class="error"></div>
    </div>
  </section>

  <section id="home" class="home-shell" hidden>
    <div class="home-container">
      <h2>Welcome, <span id="userName"></span></h2>
      <div class="field"><input id="friendEmail" class="input" placeholder="Friend's Email" /><button id="addFriendBtn" class="btn btn-primary">Add Friend</button></div>
      <div class="friends-list" id="friendsList"></div>
      <div class="chat-box" id="chatBox"></div>
      <div class="field" style="display:flex; gap:8px; width:100%; max-width:420px;"><input id="messageInput" class="input" placeholder="Type a message" /><button id="sendMsgBtn" class="btn btn-primary">Send</button></div>
      <button id="logoutBtnHome" class="logout-btn">Log out</button>
    </div>
  </section>

  <script type="module">
    const firebaseConfig = { apiKey: "AIzaSyCf5F4ntJtFb6ZfVnyQwqrcZiHkPHnDz-I", authDomain: "fast-chat-b487e.firebaseapp.com", databaseURL: "https://fast-chat-b487e-default-rtdb.firebaseio.com", projectId: "fast-chat-b487e", storageBucket: "fast-chat-b487e.appspot.com", messagingSenderId: "782961045615", appId: "1:782961045615:web:41d0b3834f0fe743fa9d9a" };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, setPersistence, browserLocalPersistence, browserSessionPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, set, get, child, push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const signupForm = document.getElementById("signupForm");
    const loginForm = document.getElementById("loginForm");
    const gotoLogin = document.getElementById("gotoLogin");
    const gotoSignup = document.getElementById("gotoSignup");
    const forgotPassword = document.getElementById("forgotPassword");
    const authErr = document.getElementById("auth-error");
    const popup = document.getElementById("popup");

    const homeSection = document.getElementById("home");
    const userNameSpan = document.getElementById("userName");
    const friendEmailInput = document.getElementById("friendEmail");
    const addFriendBtn = document.getElementById("addFriendBtn");
    const friendsList = document.getElementById("friendsList");
    const chatBox = document.getElementById("chatBox");
    const messageInput = document.getElementById("messageInput");
    const sendMsgBtn = document.getElementById("sendMsgBtn");
    const logoutBtnHome = document.getElementById("logoutBtnHome");

    function showPopup(msg){ popup.textContent = msg; popup.style.display="block"; setTimeout(()=>popup.style.display="none",1500); }

    gotoLogin.onclick = () => { signupForm.hidden=true; loginForm.hidden=false; authErr.textContent=''; };
    gotoSignup.onclick = () => { loginForm.hidden=true; signupForm.hidden=false; authErr.textContent=''; };

    document.getElementById("signupBtn").onclick = async () => {
      authErr.textContent='';
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const pass = document.getElementById("password").value;
      if(!name || !email || !pass){ authErr.textContent="Fill all fields."; return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(cred.user, { displayName: name });
        await set(ref(db, `users/${cred.user.uid}`), { name, email, createdAt: Date.now() });
        showPopup("Account created successfully!");
      } catch(e){ authErr.textContent = e.message; }
    };

    document.getElementById("loginBtn").onclick = async () => {
      authErr.textContent='';
      const email = document.getElementById("loginEmail").value.trim();
      const pass = document.getElementById("loginPassword").value;
      const remember = document.getElementById("rememberMe").checked;
      if(!email || !pass){ authErr.textContent="Enter email and password."; return; }
      try{
        await setPersistence(auth, remember ? browserLocalPersistence : browserSessionPersistence);
        await signInWithEmailAndPassword(auth, email, pass);
        showPopup("Login successful!");
      } catch(e){ authErr.textContent = e.message; }
    };

    forgotPassword.onclick = async () => {
      authErr.textContent='';
      const email = document.getElementById("loginEmail").value.trim();
      if(!email){ authErr.textContent="Enter your email to reset password."; return; }
      try{
        await sendPasswordResetEmail(auth, email);
        authErr.style.color="#22c55e";
        authErr.textContent="Password reset link sent to your email.";
      } catch(e){ authErr.style.color="var(--danger)"; authErr.textContent=e.message; }
    };

    logoutBtnHome.onclick = async () => { await signOut(auth); homeSection.hidden=true; document.getElementById("auth").hidden=false; signupForm.hidden=false; loginForm.hidden=true; authErr.textContent=''; };

    addFriendBtn.onclick = async () => {
      const friendEmail = friendEmailInput.value.trim();
      if(!friendEmail) return;
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      let friendUid = null;
      snapshot.forEach(childSnap => { if(childSnap.val().email === friendEmail) friendUid = childSnap.key; });
      if(!friendUid){ showPopup('User not found'); return; }
      const currentUser = auth.currentUser;
      await set(ref(db, `friends/${currentUser.uid}/${friendUid}`), { email: friendEmail });
      showPopup('Friend added');
      loadFriends();
    };

    function loadFriends(){
      const currentUser = auth.currentUser;
      friendsList.innerHTML='';
      const friendsRef = ref(db, `friends/${currentUser.uid}`);
      onValue(friendsRef, snapshot => {
        friendsList.innerHTML='';
        snapshot.forEach(childSnap => {
          const div = document.createElement('div');
          div.classList.add('friend-item');
          div.textContent = childSnap.val().email;
          div.onclick = () => loadChat(childSnap.key);
          friendsList.appendChild(div);
        });
      });
    }

    function loadChat(friendUid){
      chatBox.innerHTML='';
      const chatRef = ref(db, `chats/${auth.currentUser.uid}_${friendUid}`);
      onValue(chatRef, snapshot => {
        chatBox.innerHTML='';
        snapshot.forEach(childSnap => {
          const msgDiv = document.createElement('div');
          msgDiv.classList.add('message');
          if(childSnap.val().sender === auth.currentUser.uid) msgDiv.classList.add('self');
          msgDiv.textContent = childSnap.val().text;
          chatBox.appendChild(msgDiv);
        });
      });

      sendMsgBtn.onclick = async () => {
        const text = messageInput.value.trim();
        if(!text) return;
        await push(ref(db, `chats/${auth.currentUser.uid}_${friendUid}`), { sender: auth.currentUser.uid, text, timestamp: Date.now() });
        await push(ref(db, `chats/${friendUid}_${auth.currentUser.uid}`), { sender: auth.currentUser.uid, text, timestamp: Date.now() });
        messageInput.value='';
      };
    }

    onAuthStateChanged(auth, user => {
      if(user){
        document.getElementById("auth").hidden=true;
        homeSection.hidden=false;
        userNameSpan.textContent = user.displayName;
        loadFriends();
      } else {
        document.getElementById("auth").hidden=false;
        homeSection.hidden=true;
        signupForm.hidden=false;
        loginForm.hidden=true;
      }
    });
  </script>
</body>
</html>
