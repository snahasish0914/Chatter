<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f0f2f5; }
    header { background:#075e54; color:white; padding:15px; font-size:20px; }
    #friends { padding:10px; }
    .friend { padding:10px; background:white; margin-bottom:5px; border-radius:5px; cursor:pointer; }
    #chat { position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; display:none; flex-direction:column; }
    #chat header { background:#075e54; color:#fff; padding:15px; }
    #messages { flex:1; padding:10px; overflow-y:auto; }
    .msg { margin:5px 0; padding:8px 12px; border-radius:15px; max-width:70%; }
    .fromMe { background:#dcf8c6; margin-left:auto; }
    .fromOther { background:#ececec; margin-right:auto; }
    #chatInput { display:flex; padding:10px; border-top:1px solid #ccc; }
    #chatInput input { flex:1; padding:8px; border:1px solid #ccc; border-radius:20px; }
    #chatInput button { margin-left:8px; padding:8px 15px; border:none; border-radius:20px; background:#075e54; color:#fff; }
    #addFriendBtn { position:fixed; bottom:20px; right:20px; width:50px; height:50px; background:#25d366; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:30px; color:#fff; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
    #searchPopup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; }
    #searchBox { background:#fff; padding:20px; border-radius:10px; width:300px; }
    #searchBox input { width:100%; padding:8px; margin-bottom:10px; }
    #searchBox button { padding:8px 15px; background:#075e54; color:#fff; border:none; border-radius:5px; }
  </style>
</head>
<body>
  <header>Welcome</header>
  <div id="friends"></div>
  <div id="addFriendBtn">+</div>

  <div id="searchPopup">
    <div id="searchBox">
      <h3>Search Friend by Email</h3>
      <input type="email" id="friendEmail" placeholder="Enter email">
      <button id="searchBtn">Add Friend</button>
    </div>
  </div>

  <div id="chat">
    <header id="chatHeader"></header>
    <div id="messages"></div>
    <div id="chatInput">
      <input id="messageInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, set, get, child, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyCf5F4ntJtFb6ZfVnyQwqrcZiHkPHnDz-I", authDomain: "fast-chat-b487e.firebaseapp.com", databaseURL: "https://fast-chat-b487e-default-rtdb.firebaseio.com", projectId: "fast-chat-b487e", storageBucket: "fast-chat-b487e.appspot.com", messagingSenderId: "782961045615", appId: "1:782961045615:web:41d0b3834f0fe743fa9d9a" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentChatId = null;
    let currentFriend = null;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loadFriends();
      } else {
        window.location.href = "index.html";
      }
    });

    function loadFriends() {
      const friendsRef = ref(db, "friends/" + currentUser.uid);
      get(friendsRef).then(snap => {
        const list = snap.val() || {};
        document.getElementById("friends").innerHTML = "";
        Object.keys(list).forEach(uid => {
          get(child(ref(db, "users"), uid)).then(userSnap => {
            if (userSnap.exists()) {
              const friendData = userSnap.val();
              const div = document.createElement("div");
              div.className = "friend";
              div.textContent = friendData.name + " (" + friendData.email + ")";
              div.onclick = () => openChat(uid, friendData.name);
              document.getElementById("friends").appendChild(div);
            }
          });
        });
      });
    }

    function getChatId(uid1, uid2) {
      return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
    }

    function openChat(friendUid, friendName) {
      currentFriend = friendUid;
      currentChatId = getChatId(currentUser.uid, friendUid);
      document.getElementById("chat").style.display = "flex";
      document.getElementById("chatHeader").textContent = friendName;
      document.getElementById("messages").innerHTML = "";
      const convRef = ref(db, "conversations/" + currentChatId + "/messages");
      onChildAdded(convRef, snap => {
        const data = snap.val();
        const div = document.createElement("div");
        div.className = "msg " + (data.from === currentUser.uid ? "fromMe" : "fromOther");
        div.textContent = data.text;
        document.getElementById("messages").appendChild(div);
        document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
      });
    }

    document.getElementById("sendBtn").onclick = () => {
      const msg = document.getElementById("messageInput").value;
      if (msg.trim() && currentChatId) {
        const convRef = ref(db, "conversations/" + currentChatId + "/messages");
        push(convRef, { from: currentUser.uid, text: msg, timestamp: Date.now() });
        document.getElementById("messageInput").value = "";
      }
    };

    document.getElementById("addFriendBtn").onclick = () => {
      document.getElementById("searchPopup").style.display = "flex";
    };

    document.getElementById("searchBtn").onclick = () => {
      const email = document.getElementById("friendEmail").value.trim();
      if (!email) return;
      const usersRef = ref(db, "users");
      get(usersRef).then(snap => {
        if (snap.exists()) {
          const allUsers = snap.val();
          let foundUid = null, foundData = null;
          Object.keys(allUsers).forEach(uid => {
            if (allUsers[uid].email === email) {
              foundUid = uid;
              foundData = allUsers[uid];
            }
          });
          if (foundUid && foundUid !== currentUser.uid) {
            set(ref(db, "friends/" + currentUser.uid + "/" + foundUid), true);
            set(ref(db, "friends/" + foundUid + "/" + currentUser.uid), true);
            loadFriends();
            alert("Friend added!");
          } else {
            alert("User not found or cannot add yourself.");
          }
          document.getElementById("searchPopup").style.display = "none";
          document.getElementById("friendEmail").value = "";
        }
      });
    };
  </script>
</body>
</html>
